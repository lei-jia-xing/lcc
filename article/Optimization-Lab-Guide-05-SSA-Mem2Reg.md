# 5. SSA 构建：支配树、支配边界、Mem2Reg

## 5.1 支配树（DominatorTree）为什么是第一步

- Mem2Reg 需要 DF（支配边界）决定 Phi 插入位置。
- CSE（按支配关系做全局值编号）需要快速判断“谁支配谁”。

## 5.2 Mem2Reg 的三个核心难点

### 难点 A：能不能提升（Promotable）

- 标量：可以尝试提升
- 数组：一般不能提升

本项目里数组读写是通过 `LOAD/STORE base,index` 表达的，这意味着对数组的提升要么完全不做，要么需要非常谨慎。

### 难点 B：Phi 插入与参数匹配

Phi 的参数个数必须严格等于前驱数，并且“哪个参数对应哪个前驱”必须稳定。

典型 bug 现象：

- 运行结果错，但 IR 看起来“差不多”
- 后端 PhiElim 插入复制后，变量值串了

建议在 Mem2Reg 中做两件事：

- 在构造 CFG 时保证前驱顺序稳定
- Phi 维护 `[(val, predBB)]` 形式，不要只存值

### 难点 C：变量重命名（Rename）

重命名通常沿支配树 DFS：

- 遇到 def：push 新版本
- 遇到 use：替换为栈顶版本
- 退出块：pop

只要你在 use/def 判定上出一点错（比如把 STORE 的 base/index 当成 def），后面所有优化都会“随机坏”。
